<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice + Text Bot (Avatar, TTS & STT)</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2b;
      --accent: #7c5cff;
      --accent-2: #36c2ff;
      --text: #e9ecf1;
      --muted: #9aa3b2;
      --success: #22c55e;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 20px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      display: grid; place-items: center; padding: 24px;
    }

    .app {
      width: min(1100px, 100%);
      display: grid; grid-template-columns: 360px 1fr; gap: 24px;
    }
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
    }

    /* LEFT: Avatar + controls */
    .left {
      background: linear-gradient(180deg, rgba(124,92,255,.12), rgba(54,194,255,.06)), var(--panel);
      border: 1px solid rgba(124,92,255,.25);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .title {
      font-size: 18px; font-weight: 700; letter-spacing: .4px; display: flex; align-items: center; gap: 10px;
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); box-shadow: 0 0 20px rgba(239,68,68,.5) }
    .status-dot.online { background: var(--success); box-shadow: 0 0 20px rgba(34,197,94,.5) }

    .avatar-wrap { display: grid; place-items: center; padding: 24px 12px 12px }
    .avatar {
      width: 180px; aspect-ratio: 1; border-radius: 50%; position: relative; overflow: hidden;
      background: linear-gradient(180deg, #142038, #0f172a);
      border: 2px solid rgba(124,92,255,.35);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display: grid; place-items: center;
    }
    .avatar.talking::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 4px solid transparent;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .subtitles { text-align: center; margin-top: 10px; min-height: 22px; color: var(--muted); font-size: 13px; }

    .controls { display: grid; gap: 10px; margin-top: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .control, select, button, input[type="text"] {
      background: #0f172a; border: 1px solid rgba(124,92,255,.25); color: var(--text);
      border-radius: 12px; padding: 10px 12px; font-size: 14px; outline: none;
    }
    button { cursor: pointer; transition: transform .05s ease, background .2s; }
    button:hover { transform: translateY(-1px); }
    .primary { background: linear-gradient(180deg, var(--accent), var(--accent-2)); border: none; }
    .danger { background: #1f2937; border-color: rgba(239,68,68,.4); color: #fee2e2; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #0f172a; border: 1px solid rgba(124,92,255,.25); font-size: 12px; color: var(--muted); }

    /* RIGHT: Chat */
    .chat {
      background: var(--panel); border-radius: var(--radius); border: 1px solid rgba(124,92,255,.25);
      box-shadow: var(--shadow); display: grid; grid-template-rows: auto 1fr auto; overflow: hidden;
    }
    .chat header { padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(124,92,255,.2); }
    .chat header .h {
      font-weight: 700; letter-spacing: .3px; display: flex; align-items: center; gap: 10px;
    }
    .chat .log { padding: 18px; overflow: auto; display: grid; gap: 12px; }
    .msg { display: grid; gap: 6px; }
    .bubble { max-width: 75%; padding: 10px 12px; border-radius: 16px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.35; }
    .from-user { justify-items: end; }
    .from-user .bubble { background: #1f2937; border: 1px solid #243042; justify-self: end; border-bottom-right-radius: 6px; }
    .from-bot .bubble { background: #101826; border: 1px solid rgba(124,92,255,.35); border-bottom-left-radius: 6px; }

    .composer { padding: 14px; border-top: 1px solid rgba(124,92,255,.2); display: grid; grid-template-columns: 1fr auto auto; gap: 10px; }
    .composer input { width: 100%; }

    .hint { color: var(--muted); font-size: 12px; margin-top: 8px; text-align: center; }
    .tag { font-size: 11px; color: var(--muted); }
    .sr-only { position: absolute; left: -9999px; }

    .k { background: #0f172a; padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(124,92,255,.25); }
  </style>
</head>
<body>
  <div class="app">
    <section class="left">
      <div class="title"><span class="status-dot" id="status"></span> Voice Assistant</div>
      <div class="avatar-wrap">
        <div class="avatar" id="avatar">
          <video id="avatarVideo" style="width: 180px; height: 180px; border-radius: 50%; object-fit: cover;" playsinline autoplay muted></video>
        </div>
        <div class="subtitles" id="subtitles">â€”</div>
      </div>

      <div class="controls">
        <label class="pill"><input id="autoListen" type="checkbox" checked /> Autoâ€‘listen after reply</label>
        <div class="row">
          <button id="btnListen" class="primary">ðŸŽ¤ Start Listening</button>
          <button id="btnStop" class="danger">â–  Stop</button>
        </div>
        <div class="hint">Mic: press <span class="k">Space</span> to toggle. Chat send: <span class="k">Enter</span>.</div>
      </div>
    </section>

    <section class="chat">
      <header>
        <div class="h">ðŸ¤– Nova â€” your voice bot</div>
        <div class="tag" id="capabilities">Loading capabilitiesâ€¦</div>
      </header>

      <div class="log" id="log" aria-live="polite" aria-relevant="additions"></div>

      <div class="composer">
        <input id="textInput" type="text" placeholder="Type a messageâ€¦" autocomplete="off" />
        <button id="sendBtn">Send</button>
        <button id="micBtn">ðŸŽ¤</button>
      </div>
    </section>
  </div>

  <script src="heygen_api.js"></script>
  <script>
    // ---------- Utilities ----------
    const qs = (s, el = document) => el.querySelector(s);
    const el = {
      status: qs('#status'), avatar: qs('#avatar'), avatarVideo: qs('#avatarVideo'),
      subtitles: qs('#subtitles'), log: qs('#log'), input: qs('#textInput'),
      send: qs('#sendBtn'), micBtn: qs('#micBtn'), btnListen: qs('#btnListen'),
      btnStop: qs('#btnStop'), autoListen: qs('#autoListen'),
      capabilities: qs('#capabilities'),
    };

    const supports = {
      tts: 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window,
      stt: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
    };
    el.capabilities.textContent = `TTS: ${supports.tts ? 'Yes' : 'No'} â€¢ STT: ${supports.stt ? 'Yes' : 'No'}`;

    function pushMessage(text, who = 'bot') {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (who === 'user' ? 'from-user' : 'from-bot');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      wrap.appendChild(b);
      el.log.appendChild(wrap);
      el.log.scrollTop = el.log.scrollHeight;
    }

    function setTalking(on) {
      el.avatar.classList.toggle('talking', !!on);
      el.status.classList.toggle('online', !!on);
    }

    // ---------- Simple reply logic (replace with your API) ----------
    function smartReply(userText) {
      const t = userText.trim().toLowerCase();
      if (!t) {
        return "Say something and I'll respond!";
      } else if (/\b(hello|hi|hey)\b/.test(t)) {
        return "Hey there! I'm Nova. How can I help you today?";
      } else if (/\btime\b/.test(t)) {
        return `The current time is ${new Date().toLocaleTimeString()}.`;
      } else if (/\b(date|day)\b/.test(t)) {
        return `Today's date is ${new Date().toLocaleDateString()}.`;
      } else if (/\b(name|who are you)\b/.test(t)) {
        return "I'm Nova, your friendly voice assistant.";
      } else if (/\b(joke|funny)\b/.test(t)) {
        return "Why don't scientists trust atoms? Because they make up everything!";
      } else if (/\b(weather)\b/.test(t)) {
        return "I can't check the weather right now, but I hope it's nice where you are!";
      } else if (/\b(story|read)\b/.test(t)) {
        return "Once upon a time, in a land of code, a little bot dreamed of chatting with the world. And now, here I am!";
      } else if (/\b(what can you do|help)\b/.test(t)) {
        return "You can ask me for the time, a joke, a short story, or just chat with me. I'm here to listen!";
      } else if (/\b(thank you|thanks)\b/.test(t)) {
        return "You're welcome!";
      } else {
        return `I'm not sure how to reply to "${userText}", but I'm always learning.`;
      }
    }

    // ---------- Text-To-Speech (Now handled by HeyGen) ----------
    let speaking = false;
    const HEYGEN_AVATAR_ID = '7733b528cbe5428eb3412d34541ca397';

    // Helper function for polling
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function speak(text) {
      if (!text) return;

      setTalking(true); // Show loading indicator
      el.subtitles.textContent = 'Generating video...';

      try {
        const videoId = await generateVideo(text, HEYGEN_AVATAR_ID);

        let videoStatus;
        while (true) {
          await sleep(2000);
          videoStatus = await checkVideoStatus(videoId);
          if (videoStatus.data.status === 'completed') {
            break;
          } else if (videoStatus.data.status === 'failed') {
            const reason = videoStatus.data.error ? videoStatus.data.error.message : 'Unknown reason';
            throw new Error(`Video generation failed: ${reason}`);
          }
        }

        const videoUrl = videoStatus.data.video_url;
        el.subtitles.textContent = text;

        el.avatarVideo.src = videoUrl;
        el.avatarVideo.muted = false; // Unmute for playback

        el.avatarVideo.onplay = () => {
          setTalking(false); // Hide loading indicator
        };

        el.avatarVideo.onended = () => {
          el.subtitles.textContent = 'â€”';
        };

        await el.avatarVideo.play();

      } catch (error) {
        console.error('Error in HeyGen video generation:', error);
        el.subtitles.textContent = 'Sorry, I couldn\'t generate a video.';
        setTalking(false);
      }
    }

    // ---------- Speech-To-Text ----------
    let rec = null; let listening = false;
    if (supports.stt) {
      const R = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new R();
      rec.lang = navigator.language || 'en-US';
      rec.interimResults = true;
      rec.continuous = false; // one utterance

      let interim = '';
      rec.onstart = () => { listening = true; el.status.classList.add('online'); el.subtitles.textContent = 'Listeningâ€¦'; };
      rec.onresult = (e) => {
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          if (res.isFinal) final += res[0].transcript; else interim += res[0].transcript;
        }
        el.subtitles.textContent = final || interim || 'Listeningâ€¦';
      };
      rec.onerror = (e) => { console.warn('STT error', e.error); el.subtitles.textContent = 'Mic error: ' + e.error; listening = false; el.status.classList.remove('online'); };
      rec.onend = async () => {
        listening = false; el.status.classList.remove('online');
        const text = el.subtitles.textContent.trim();
        if (text && text !== 'Listeningâ€¦') {
          handleUserText(text);
        } else {
          el.subtitles.textContent = 'â€”';
        }
      };
    }

    async function startListening() {
      if (!rec) return alert('Speech recognition not supported in this browser. Try Chrome.');
      if (speaking) window.speechSynthesis.cancel();
      try { rec.start(); } catch { /* already started */ }
    }
    function stopAll() {
      if (rec && listening) rec.stop();
      if (supports.tts && speaking) window.speechSynthesis.cancel();
      setTalking(false);
      el.subtitles.textContent = 'â€”';
    }

    // ---------- Message flow ----------
    async function handleUserText(text) {
      pushMessage(text, 'user');
      el.input.value = '';
      const reply = smartReply(text);
      pushMessage(reply, 'bot');
      await speak(reply);
      if (el.autoListen.checked) startListening();
    }

    // ---------- Events ----------
    el.send.addEventListener('click', () => {
      const val = el.input.value.trim();
      if (val) handleUserText(val);
    });
    el.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); const v = el.input.value.trim(); if (v) handleUserText(v); }
    });

    el.btnListen.addEventListener('click', startListening);
    el.micBtn.addEventListener('click', startListening);
    el.btnStop.addEventListener('click', stopAll);

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.repeat) {
        e.preventDefault(); listening ? stopAll() : startListening();
      }
    });

    // Greet on load
    pushMessage("Hello! I'm Nova. Tap the mic or press Space and talk to me.");
    if (supports.tts) speak("Hello! I'm Nova. Tap the mic or press Space and talk to me.");
  </script>
</body>
</html>
